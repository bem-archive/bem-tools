## bem bench - тестирование скорости шаблонов


Инструмент позволяет выполнять регрессионное тестирование производительности `BEMHTML` шаблонов, сравнивая скорость выполнения шаблонов между указанными ревизиями проекта и текущей рабочей копией.

Результатом выполнения команды **bem bench**, с ревизиями репозитория в качестве агрументов
`../project-stub$ bem bench HEAD~1 HEAD`

будет таблица, где:
 - **benchmark** - имя теста;
 - столбцы с результатами тестируемых ревизий, это количество выполнений шаблонов в секунду, а так же `RME` – относительная погрешность, выраженная процентно от среднего арифметического. По `RME` можно судить, насколько истины результаты тестирования;
 - **RME-stat** - показывает, был ли сильный скачек в погрешностях. Как определяется стабильность состояния? Находится максимальная и минимальная `RME` по одному тесту, если их разность превышает допустимую погрешность `5%` (величина была получена в ходе экспериментов и она изменима), то такое состояние считается `unstable` в ином случае `stable`.

Следствием значительного разброса `RME` является загруженность `CPU` в момент тестирования. По возможности необходимо выгружать фоновые процессы и ПО активно использующее `CPU`. Не стоит доверять результатам тестов при значительном разбросе `RME`.

![Результаты](https://raw.github.com/bem/bem-tools/bench/docs/bem-bench/bem-bench.ru.jpg "Рисунок 1 — Результаты тестирования")

*Рис. 1. — Результаты тестирования*

#### Опции

 Опция | Алиас   | Описание|
:-------:|:-------:| :-------|
| `-w`    | `--wcs` | Позволяет запустить тесты не используя рабочую копию. |
| `-b`    | `--benchmark` | Позволяет запускать конкретные тесты, не собирая весь проект. Принимает 1 параметр (строка - имя теста). Возможно указать одновременно несколько тестов ( **-b b-logo -b b-link** ).|
| `-dr`    | `--delta-rme` | Позволяет изменить допустимое значение погрешности для **RME-stat**. Значение по умолчанию - **5%**. |
| `-ob`    | `--only-bench` | Позволяет запустить тесты пропуская этап сборки, используя тесты собранные последний раз. |
| `-wait`    |  | **"Активное ожидание"**. Принимает 1 параметр (число), которым является задержка в секундах. Данная задержка необходима между запусками пакетов тестов, для сглаживания **RME**. Значение по умолчанию **20сек**. Это значение напрямую влияет на **RME**. Эксперементы показывают, что при использовании режима `ONLY BECHMARKS` параметр `-wait` можно устанавливать в **0**.|

#### Конфигурирование проекта для запуска тестов, на примере **project-stub**.

Для запуска **bem-bench** необходимо внести несколько изменений в конфигурационные файлы проекта:

1) Необходимо дописать следующий код  в метод `getTechs`, в файлe `./.bem/make.js`, который указывает, какие технологии собирать для тестов.

```js

MAKE.decl('BundleNode', {

    getTechs: function() {
        
        if (PATH.basename(this.level.dir) === 'benchmark.bundles')  {
            return [
                'bemjson.js',
                'bemdecl.js',
                'deps.js',
                'bemhtml'
            ];
        }
        ...
    }
});    
        
```

2) Создать конфигурационный файл уровня переопределения `./.bem/levels/benchmarks.js`, с содержимым:

```js
var BEM = require('bem');
    PATH = require('path'),

    pjoin = PATH.join,
    presolve = PATH.resolve.bind(null, __dirname),

    PRJ_ROOT = presolve('../../'),

    PRJ_TECHS = presolve('../techs/'),
    BEMBL_TECHS = pjoin(PRJ_ROOT, 'bem-bl/blocks-common/i-bem/bem/techs');


exports.baseLevelPath = require.resolve('./bundles.js');

exports.getConfig = function() {

    return BEM.util.extend(this.__base() || {}, {
        bundleBuildLevels: this.resolvePaths([
            '../../bem-bl/blocks-common',
            '../../bem-bl/blocks-desktop',
            '../../common.blocks',
            '../../desktop.blocks'
        ])
    });

};

exports.getTechs = function() {

    return {
        'bemjson.js'    : pjoin(PRJ_TECHS, 'bemjson.js'),
        'bemdecl.js'    : 'bemdecl.js',
        'deps.js'       : 'deps.js',

        'bemhtml'       : pjoin(BEMBL_TECHS, 'bemhtml.js')
    };

};

// Create bundles in bemjson.js tech
exports.defaultTechs = ['bemjson.js'];
```

3) Создать уровень переопределения:
`bem create level -l .bem/levels/benchmarks.js benchmark.bundles`

Тесты должны находится в директории `./benchmark.bundles/`

*Пример расположения файлов:*
```
 benchmark.bundles/
        b-logo/
            b-logo.bemjson.js
        b-link/
            b-link.bemjson.js
        b-mix-input-button/
            b-mix-input-button.bemjson.js    
```
